---
title: FlexGlO Initial Setup
description: See my new project!
---
<!--bundle exec jekyll serve //Will run this locally-->
<!--http://localhost:4000 //Locally as in here-->

<head>
  <!-- KaTeX CSS for styling -->
  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
  </script>
</head>

<div style="background-color: #f8f9fa; padding: 10px; text-align: center; border-bottom: 1px solid #ddd;">
  <p style="margin: 0; font-size: 14px; color: grey; font-style: italic;">
    Co-Designers:
    Matt (<a href="https://github.com/Mbutton-umich" style="color: blue; text-decoration: none;">Mbutton-umich</a>),
    Ernesto (<a href="https://github.com/ernestogomezs" style="color: blue; text-decoration: none;">ernestogomezs</a>),
    Pablo (<a href="https://github.com/pgaracu" style="color: blue; text-decoration: none;">pgaracu</a>),
    Sammy (<a href="https://github.com/saadsammy" style="color: blue; text-decoration: none;">saadsammy</a>), and
    Youssouf (<a href="https://github.com/ysiditech" style="color: blue; text-decoration: none;">ysiditech</a>)
  </p>
</div>

<div style="display: flex; justify-content: center; margin: 20px;">
  <div class="toc" style="border: 1px solid #ddd; padding: 10px; border-radius: 5px; max-width: 300px; text-align: center;">
    <h3 style="margin: 0; font-size: 16px; cursor: pointer;" onclick="toggleTOC()">Table of Contents</h3>
    <ul id="toc-list" style="list-style: none; padding: 10px; display: none; text-align: left;">
      <li><a href="https://github.com/Mbutton-umich/FlexGlO" style="text-decoration: none; color: blue; font-weight: bold;">The Code (Link to Git)</a></li>
      <li><a href="#the-pitch-section" style="text-decoration: none; color: blue; font-weight: bold;">The Pitch</a></li>
      <li><a href="#implementation-section" style="text-decoration: none; color: blue; font-weight: bold;">Implementation</a></li>
      <ul style="padding-left: 20px; list-style: disc;">
        <li><a href="#analog-acquisition-section" style="text-decoration: none; color: blue;">Analog Acquisition</a></li>
        <li><a href="#digital-sampling-section" style="text-decoration: none; color: blue;">Digital Sampling</a></li>
        <li><a href="#fiber-optics-section" style="text-decoration: none; color: blue;">The LEDs</a></li>
        <li><a href="#power-considerations-section" style="text-decoration: none; color: blue;">Power Considerations</a></li>
        <li><a href="#pcb-section" style="text-decoration: none; color: blue;">The PCB</a></li>
        <li><a href="#ble-section" style="text-decoration: none; color: blue;">Connectivity with BLE</a></li>
        <li><a href="#app-section" style="text-decoration: none; color: blue;">The Flutter App</a></li>
        <li><a href="#house-section" style="text-decoration: none; color: blue;">3D Printed Shell</a></li>
        <li><a href="#textile-section" style="text-decoration: none; color: blue;">Shirt Construction</a></li>
      </ul>
      <li><a href="#leftovers-section" style="text-decoration: none; color: blue; font-weight: bold;">Contact and Lingering Questions</a></li>
      <li><a href="#thankyou-section" style="text-decoration: none; color: blue; font-weight: bold;">Special Thanks</a></li>
    </ul>
  </div>
</div>

<script>
  function toggleTOC() {
    const tocList = document.getElementById('toc-list');
    tocList.style.display = tocList.style.display === 'block' ? 'none' : 'block';
  }
</script>

<div id="the-pitch-section" style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
  <div style="flex: 2;">
    <audio id="audio" src="assets/audio/arnold_endorse.mp3"></audio>
    <script>
        function playAudio() {
            const audio = document.getElementById("audio");
            audio.play();
        }
    </script>
    <h1>
        <a href="#" onclick="playAudio()" style="text-decoration: none; color: inherit;">
            <span style="color: blue; text-decoration:">What</span> is 
            <span style="color:#39FF14;">FlexGl</span><span style="color:#FF073A;">O</span>?  
        </a>
        <sub style="font-size: 30%; margin-left: 50px;"><i>...listen when you click 'What'</i></sub>
    </h1>
    <p>
      Imagine a shirt that transforms your body into a living canvas of motion and energy.  
      This isn't just a garment—it's a gateway to visualizing the power within. Using cutting-edge <strong>EMG (electromyography)</strong> sensors strategically placed across key upper-body muscle groups, this innovative shirt detects even the subtlest electrical signals generated by muscle activation.  
      The result? A spectacular symphony of light, brought to life by vibrant <strong>LEDs</strong>, dynamically illuminating your movements in real-time. Witness the light of your own heart pulse on your chest, captured via <strong>EKG (electrocardiogram)</strong>.
    </p>
  </div>

  <div style="flex: 1; text-align: center;">
    <img src="assets/gifs/gif_ex.gif" alt="FlexGlO demo GIF" style="max-width: 100%; height: auto; border-radius: 8px;">
    <p style="font-style: italic; margin-top: 8px; font-size: 12px;">
    Fig. I: <span style="color: #39FF14;">FlexGl</span><span style="color: #FF073A;">O</span> in Action.
    </p>
  </div>
</div>
### Why <span style="color:#39FF14;">FlexGl</span><span style="color:#FF073A;">O</span>?

Are you cheating on your curls? Now we can see that you are. Quantify muscle imbalances or movement weaknesses as **5 BLE nodes** collect data across the body for rehab or performance purposes. Fitness analytics at the speed of light. Are you giving maximum effort in every rep? Simply glance at your mobile device to see the voltage output and muscle activity in real-time.

### Features
- **Precision EMG Monitoring**: Sense the electrical activity of your biceps, triceps, pectorals, deltoids, and more, translating your strength into a visual spectacle.
- **Precision EKG Monitoring**: View the beating of your own heart as you proceed with your workout.
- **Dynamic Illumination**: LED strips glow and shift in intensity, providing an electrifying display of muscle engagement that mirrors your every move.
- **Seamless Integration**: Lightweight, flexible design ensures complete freedom of movement, whether you’re powering through a workout or performing on stage.
- **Washable and Durable Construction**: Features 5 removable BLE nodes for effortless cleaning and maintenance.
- **Customizable Visuals**: Choose from color gradients, patterns, or animations to suit your preferences and mood.


<div style="display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
  <!-- Phrase Section -->
  <div style="text-align: right; padding-right: 10px;">
    <p style="margin: 0; font-size: 24px; font-style: italic; font-weight: bold; line-height: 1.2; color: #333;">
      STRENGTH<br>ILLUMINATED
    </p>
  </div>

  <!-- Logo Section -->
  <div>
    <img src="assets/images/FlexGlo_logo.png" alt="FlexGlO Logo" style="max-width: 150px; height: auto;">
  </div>
</div>

<div style="display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #ddd; padding-bottom: 20px; margin-bottom: 20px;">
  <div style="flex: 1; text-align: center; padding-right: 10px; border-right: 1px solid #ccc;">
    <img src="assets/images/shirt_layout.png" alt="Shirt Layout" style="max-width: 100%; height: auto;">
  </div>
  <div style="flex: 1; text-align: center; padding: 0 10px; border-right: 1px solid #ccc;">
    <img src="assets/images/Shine.jpg" alt="Shiney Photo" style="max-width: 100%; height: auto;">
  </div>
  <div style="flex: 1; text-align: center; padding-left: 10px;">
    <img src="assets/images/batman2.jpg" alt="FlexGlO Action 3" style="max-width: 100%; height: auto;">
  </div>
</div>

<p style="text-align: center; font-style: italic; margin-top: 10px;font-size: 12px;">
  Fig. II: <span style="color: #39FF14;">FlexGl</span><span style="color: #FF073A;">O</span> Muscle Shirt in Action.
</p>
<div id="implementation-section" style="text-align: left; margin-top: 40px; margin-bottom: 20px;">
  <h1>Implementation Details</h1>
  Sales speak aside we developed this "muscle shirt" over the course of three months and kept our budget to under $1000.00. In this general summary we <strong style="color: blue;">bolded</strong> some key terms if you are interested in tackling similar challenges or projects with similar components.
  <br><br>
  <p>Aquiring muscle signals for EMG and EKG is done using Analog Devices <strong style="color: blue;">AD623</strong> a moderately priced chip that works well for breadboarding because it still comes in a DIP package. The <strong style="color: blue;">single-supply analog filters</strong> all utilize <strong style="color: blue;">TLV246X</strong> chips from Texas Instruments (TI) which again come in DIP packages and are well supported by TI's simple SPICE simulator and filter design widget. We selected <strong style="color: blue;">ESP32-S3 WROOM 1</strong> as the platform for the project for several reasons: the module's integrated antenna, the dual core, and its support and ubiquity amongst hobbyists. All of the code was developed in <strong style="color: blue;">Arduino IDE</strong> in <strong style="color: blue;">embedded C</strong> utilizing <strong style="color: blue;">FreeRTOS</strong> and <strong style="color: blue;">hardware timers</strong> for strict scheduling. The system is powered with a generic 3.7V 850mAh Li-Po pouch and regulated with TI's <strong style="color: blue;">TLV1117LV33</strong> to 3.3V at 1A. The eventual PCBs were created in <strong style="color: blue;">KiCad</strong> and programmed via th onboard  <strong style="color: blue;">USB Serial/JTAG Controller Console</strong>. We use <strong style="color: blue;">multi-channel continuous reads over DMA (direct memory access)</strong> to sample up to three muscles at once at every node. That information is then aggregated and processed quickly to be displayed in <strong style="color: blue;">real-time</strong> with quick updates to <strong style="color: blue;">WS2813 LED strips</strong> using the <strong style="color: blue;">FastLED library</strong>. We also quickly send updates to a <strong style="color: blue;">Flutter</strong> mobile application from all five nodes across the upper body. This app allows users to view muscle activation across the whole upper body, or to zoom in and see a live oscilloscope-style view of any particular muscle. From the app, you can also change the LED colors or log data for later analysis. At the tail end of the project, we also tried to do some movement identification once data is collected at the app in <strong style="color: blue;">Dart</strong> using some binary matrix manipulations.
  
 

  <div id="analog-acquisition-section" style="display: block; padding-bottom: 20px;">
    <h2 style="margin-left: 20px; font-style: italic;">Analog Acquisition</h2>
    <!-- Left side: First paragraph -->
    <p style="padding-left: 20px;">
      We use an Analog Devices instrumentation amplifier AD623 as the pre-Amp phase to extract muscle signals off of the surface of the skin. As you flex a given muscle neurons are firing a ripple of activation signals along the muscle fibers that propogate out to the surface of the skin. With a high impedance differential amplifier we can measure the differnce in voltage between two close points and quantify that activation energy. Under the shirt, users need to put roughly 30 Red Dot Electrodes that button nicely into our electrode snaps and feed into each node via 2.5 mm TRRS (AUX) jacks. It took a lot of testing to select the correct gain resistor for EMG and EKG. We initially used a potentiometer to dial in the correct gain for our purposes; unfortunately, we found the resistance on the breadboard to be pretty finicky and unstable. For the PCB, we landed on 300&Omega; for the EMG and 100&Omega; for the EKG circuit. These minscule muscle activation signals are in the range [50&mu;V, 30mV] for EMG and [500&mu;V, 5mV] for EKG. We needed strike a balance and select a gain that is large enough to bring these voltages into the full range of our ADC ([0, 3.3]V) but not so large that upon activation we get instant saturation. From the AD623 datasheet that places our selected gains at:
    </p>
      <div style="text-align: center; margin-top: 30px;">
        $$
          R_G = \frac{100\, \text{k}\Omega}{G - 1} \implies G = 1 + \frac{100\, \text{k}\Omega}{R_G} \implies 
          \left\{
            \begin{array}{l}
              G_{EMG} = 1 + \frac{100\, \text{k}\Omega}{300 \, \Omega} = 334.33 \\
              G_{EKG} = 1 + \frac{100\, \text{k}\Omega}{100 \, \Omega} = 1000
            \end{array}
          \right.
        $$
      </div>
      <p style="padding-left: 20px;"> 
      From the jump, we also wanted to avoid the dual-supply setup we saw on a lot of online EXG tutorials. So we used a voltage divider at the reference pin to bump negative muscle signals into the [0, 3.3]V range within the rails. For the entire analog design process, we relied heavily on TI's <a href="https://webench.ti.com/filter-design-tool/filter-type" style="color: blue;">Filter Design Tool</a> and made sure to scale things to the most common ceramic capacitor and resistor sizes where possible.
    </p>
    
    <!-- Bullet list and paragraph placed under the first paragraph -->
    <p style="padding-left: 20px;">There were also three other TI "Application Reports" that were super helpful <em>especially the last one</em> which explicitly shows how to modify things for single-supply:</p>
    <ul style="text-align: left; margin-top: 10px; padding-left: 120px;">
      <li><a href="https://www.ti.com/lit/an/sloa024b/sloa024b.pdf" style="color: blue;">Analysis of Sallen-Key Architecture</a></li>
      <li><a href="https://www.ti.com/lit/an/sloa030a/sloa030a.pdf" style="color: blue;">Single-Supply Op Amp Design Techniques</a></li>
      <li><a href="https://www.ti.com/lit/an/sloa096/sloa096.pdf" style="color: blue;">More Filter Design on a Budget</a></li>
    </ul>
  </div>
  <div>
       <p style="padding-left: 20px;">
      After the instrumentation amp the boosted signal proceeds through a series of filter stages. For the EMG we use a Sallen-Key Low Pass followed by a Sallen-Key High Pass filter to create a bandpass and extract relevant EMG frequencies in the range [5, 500]Hz. After the bandpass the the final stage is a two amp Fleige Notch Filter to remove 60Hz interference which was very prevalent in the lab where we did most of our testing. The EMG filter architecture is shown below using a rail-to-rail quad-amp TLV2464 IC from TI (and the EKG schematic is in the Git):
    </p>
  </div>
    <div style="text-align: center; margin-top: 30px;">
    <img src="assets/images/EMG_Filter.png" alt="Big Image" style="max-width: 100%; height: auto; border-radius: 8px;">
    <p style="font-style: italic; margin-top: 8px; text-align: center; font-size: 12px;">
      Fig. III: The EMG filter schematic.
    </p>
  </div>
    


  <div style="display: flex; justify-content: space-between; align-items: flex-start;">
    <div style="flex: 1; padding-right: 20px;">
      <p style="padding-left: 20px;">
        The EKG circuit is similar to the EMG with just changes to the electrode placement and the filter passives to bring the frequency range within [0.2, 200]Hz. After their conception, we used TINA (TI's Interactive Network Analyze) to simulate both the EKG and EMG circuits. To the right is an ad-hoc sweep of the EMG filter to make sure the bandpass cutoffs are about right. TINA was pretty useful because we had at least some assurance that the circuit would work before ever ordering parts. We also got a nice frequency response plot of the circuit. In simulation for example, we could tune the depth and width of the 60Hz notch by playing with the values of the R_M_O# pair of resistors in the schematic.
        <img src="assets/images/EMG_Filter_sim.jpg" alt="EMG Sim" style="max-width: 100%; height: auto; border-radius: 8px; display: block; margin-left: auto;">
      </p>
    </div>
    
    <!-- Right side: Image and caption -->
    <div style="text-align: right; max-width: 100%; display: inline-block;">
      <img src="assets/gifs/cropped_sim.gif" alt="FlexGlO demo GIF" style="max-width: 70%; height: auto; border-radius: 8px; display: block; margin-left: auto;">
    </div>
  </div>
  

<div>
  <p style="font-size: 12px; font-style: italic; margin-top: 8px; text-align: center; max-width: 100%; word-wrap: break-word;">
    Fig. IV: [Right] TINA Simulator Oscilloscope showing the response of the full EMG filter at different frequencies.<br>[Bottom] Bode Plot of showing filter magnitude and phase.
  </p>
  </div>
  <div>
    <p style="padding-left: 20px;">
    After all that simulation we purchased through-hole parts to build the circuit in breadboard form. For uniformity we stuck with Yageo for resitors and Kemet for capacitors maintaining &le;5% tolerances to keep the circuit realization close to the simulations. The EMG breadboard worked without issue despite the tangled mess of the Notch filter on the small breadboard.
    <br><br>
    However our EKG proved more challenging as the signal was very weak when we used the canonical three-lead electrode placement from SENIAM (Surface ElectroMyoGraphy for the Non-Invasive Assessment of Muscles). At maximum gain the heartbeat was still almost too faint to be recognized by the ADC. Also moving your leg, breathing, or flexing your chest would drag the signal all around. A great link: <a href="https://www.aclsmedicaltraining.com/blog/guide-to-understanding-ecg-artifact/" style="color: blue; text-decoration: none;">Guide to Understanding ECG Artifact</a>, allowed us to understand we were witnessing a "wandering baseline". To remedy this issue we changed from a bandpass and notch combination to a lone narrow bandpass in the range [0.25, 25]Hz. We also experimented with alternative electrode placement to obtain a stronger heartbeat signal. After trying a F-EKG three-lead constellation with placement on the sternum and lower left rib we had better results. This electrode constellation captures the "&epsilon;-Wave" as opposed to the "R-Wave" and it just worked better for our purposes of capturing a BPM.
    </p>
  </div>
  <div style="display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #ddd; padding-bottom: 20px; margin-bottom: 20px;">
  <!-- First GIF -->
  <div style="flex: 1; text-align: center; padding-right: 10px; border-right: 1px solid #ccc;">
    <img src="assets/gifs/analog_EMG_test.gif" alt="EMG Test" style="max-width: 100%; height: auto;">
  </div>

  <!-- Second GIF -->
  <div style="flex: 1; text-align: center; padding: 0 10px; border-right: 1px solid #ccc;">
    <img src="assets/images/EMG_Breadboard.jpg" alt="EMG Breadboard" style="max-width: 100%; height: auto;">
  </div>

  <!-- Third GIF -->
  <div style="flex: 1; text-align: center; padding-left: 10px;">
    <img src="assets/gifs/analog_EKG_test.gif" alt="EKG Test" style="max-width: 100%; height: auto;">
  </div>
</div>
<p style="text-align: center; font-style: italic; margin-top: 10px; font-size: 12px;">
  Fig. V: [Left] EMG analog test with LED output. [Center] EMG I-Amp and Filter Breadboard. [Right] EKG analog test with LED output.
</p>

<div id="digital-sampling-section" >
  <h2 style="margin-left: 20px; font-style: italic;">Digital Sampling and Conditioning</h2>
</div>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
  <div style="flex: 1; text-align: center;">
    <img src="assets/images/digi_block_diag.png" alt="ADC Block Diagram" style="max-width: 100%; height: auto; border-radius: 8px;">
    <p style="font-style: italic; margin-top: 8px;font-size: 12px;">Fig. VI: Block diagram of muscle signal sampling and conditioning.</p>
  </div>

  <!-- Right side: Text content -->
  <div style="flex: 1; padding-left: 20px;">
    <p>
      After all the hard work aquiring and cleaning the muscle signals we eventually pass them through the ESP32-S3's ADC and into the digital domain. Recall that each node has at most three muscles (EMG0, EMG1, and EKG), so initally we were doing single shot conversions for three channels. Also recall that EMG is in the range [5, 500]Hz so we wanted to sample above the Nyquist rate of 1kHz. As we got closer to 1kHz we found the CPU was overwhelmed with all of the interrupts for sampling all three channels. To reduce the load on the CPU we instead switched to a continuous sampling of three channels over DMA. Although there was example code for continous sampling on a single channel of the ESP32 ADC there was less support for multi-channel sampling via DMA. Fortunately the Expressif documentation was decently clear and after a small struggle we were able to configure the DMA appropriotely. The sampling and signal conditioning process largely follows the block diagram to the left:
      <br><br>
      Everything occurs sequentially on Core 1: DMA fills its buffer which releases the process_ADC FreeRTOS task. After process_ADC finishes the process_LEDs task is released and will display our most recently measured values via the LEDs. And to be clear when I say "released" I mean we use defferred interrupt handling. So a quick interrupt sets a flag that unblocks a task or I explcitly release a task which in FreeRTOS-speak means using <span style="font-family: Consolas, monospace;">xTaskNotifyGive(...)</span>.
      <br><br>
      A few more notes on design decisions. We had to rectify digitally because we made our analog front end single-supply. Normally, with a zero centered signal we could just add a diode bridge at the end of the filters and an RC smoother to rectify the signal. However, with the 1.65V offset single-supply signal we just flip the lower values coming off the ADC. This way we can get a kind of absolute value for muscle activity which is translated into levels once given to the process_LEDs task.
    </p>
  </div>
</div>
  <div style = "padding-left: 20px;">
    <p>
    It's also worth noting everything about the conditioning pipeline is parameterized. We experimented with different DMA buffer sizes and the subsequent median filter window lengths. Again from testing we had to strike a balance: if the filter window is too long we flatten away brief moments of muscular exertion and its difficult to max out the LED bar; if we make it too short we don't smooth out the divots from rectification and the LEDs look very flickery and faint. Also if you make the buffer too big we produce a median at a rate below the Nyquist and allias effects take hold. In the end we selected a window of size 8 at 8kHz DMA. Before switching to DMA we had actually used a moving average filter but with the DMA setup we are collecting data in bunches of full buffers so the median filter (which was more robust against occasional noisy outliers) was a better choice for a similar computational cost.

    Finally, the Arduino serial plotter was a particularly useful tool for debugging all of this ADC code. We could visually inspect how the signals are sampling and rectifying and averaging to make judgments about the qaulity of our signal chain. Although at high sampling frequencies the <span style="font-family: Consolas, monospace;">Serial.print(...)</span> would lag or crash it was a heavily leveraged asset.
    </p>
  </div>
  <div style="text-align: center; margin-top: 30px;">
<img src="assets/images/rectified_test.png" alt="Rectified Arduino" style="max-width: 80%; height: auto; border-radius: 8px;">
<p style="font-style: italic; margin-top: 8px; text-align: center;font-size: 12px;">
Fig. VII: Arduino Serial Plotter showing rectification of a 20mV signal at 32Hz.
</p>
</div>

<div id="fiber-optics-section" style="text-align: left; margin-left: 20px;">
  <h2 style=" font-style: italic;">Fiber Optics...Muscle Fiber Optics</h2>
  <p>
    We are fully indebted to the FastLED library, which allows us to update the LED bars and the LED circle for the heart pulse. There were basically no problems with the library, and the interfaces are very clean. The only hiccup involved multiple tasks contending for control of RMT assets. In prior projects, we had bit-banged the data lines for these strips, but we were fortunate that FastLED does this and does it efficiently. For the bars, we simply range down the median coming off the ADC and ignite that number of LEDs. For the EKG circle, the actual heart pulse was too quick and looked very faint, so we used some software tricks to give a "stickiness" to the heartbeat to make it more prominent. FastLED uses the RMT (Remote Control Transceiver) peripherals to bit-bang the precise PWM patterns and encode colors to the strips. The ESP32-S3 has 4 transmission RMT channels, so the three strips compute the colors and levels serially and then update in parallel.
  </p>

  <p>
    We also made a nice "start-up pulse" animation (in maize and blue) and a "waiting to connect" animation. Although we developed these initially as flair for the system, they were actually incredibly useful. When debugging, the chip might crash or disconnect, and having those visual cues was a big help.
  </p>

  <p>
    For the final system on the PCB, we also measured the FPS (frames per second) for all the LEDs updating. We fall within [110, 150] FPS for regular operation. We selected WS2813 strips in particular for several reasons:
  </p>
</div>

<div>
  <ul style="padding-left: 120px; margin-top: 10px;">
    <li>The dual redundant data lines are good if a cable breaks during regular exercise.</li>
    <li>The refresh rate is limited by the 280 ns reset time, allowing faster strip updates over the cheaper WS2812B variety.</li>
    <li>For small strips, the 5V source voltage can be satisfied with only 3.3V.</li>
  </ul>
</div>

<div style="text-align: left; margin-left: 20px;">
  <p>
    That last point was a particular concern for us because we are running the sensor nodes off of a 3.7V lithium battery and stepping things down further via an LDO to 3.3V. We probably should have included a level shifter, but it would have taken up space on our board. Luckily, after testing on the development breadboard, even the 12 LED circle strip lit up without turning red or fading at only 3.3V.
  </p>
</div>

<div style="display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #ddd; padding-bottom: 20px; margin-bottom: 20px;">
  <div style="flex: 1; text-align: center; padding-right: 10px; border-right: 1px solid #ccc;">
    <img src="assets/gifs/christmas.gif" alt="Christmas" style="max-width: 100%; height: auto;">
  </div>
  <div style="flex: 1; text-align: center; padding: 0 10px; border-right: 1px solid #ccc;">
    <img src="assets/gifs/gif_ex.gif" alt="pot gif" style="max-width: 100%; height: auto;">
  </div>
  <div style="flex: 1; text-align: center; padding-left: 10px;">
    <img src="assets/gifs/BB_startup.gif" alt="Startup Animation" style="max-width: 100%; height: auto;">
  </div>
</div>

<p style="text-align: center; font-style: italic; margin-top: 10px; font-size: 12px;">
  Fig. VIII: [Left] PCB outputting random voltages from thumb. [Center] Development breadboard showing smooth level transition with potentiometer. [Right] Startup and wait animations.
</p>



<!-- First paragraph outside the flex container -->
<div id= "power-considerations-section" style="margin-left: 20px; text-align: left;">
  <h2 style="font-style: italic;">Power Considerations</h2>
  <p>
    Because of how the analog, the code, and the BLE was developed concurrently it was somewhat difficult to ascertain the peak current draw of the full system until we received the PCB. First we did some napkin math:
  </p>
</div>

<!-- Flex container for the remaining content -->
<div style="display: flex; align-items: flex-start; margin-left: 20px; gap: 20px;">
  <!-- Text container -->
  <div style="flex: 1;">
    <p>
      At "full-white" the addressable RGB LEDs require 60mA of current (20mA for each R-G-B). We have \(10+10+12 = 32 \) LEDs. We wanted to try to keep to a single color channel and after testing decided that 75% brightness was suitable for our purposes. So \(32(1mA+1mA+20mA)(75\%)=528mA\). We also have three instrumentation amps and the filter amps to accompany them; from the breadboard we measured the draw on those to be \(\leq 20mA\). Finally considering the ESP32-S3 current draw: The ESP Hardware Design Guidelines recommends a 500mA LDO to support the device. The datasheet also gives the consumption for "Active RF" as 340mA and 110mA for a "CPU at full-load". Combining all of these estimates together and we obtain: \(528mA+20mA+340mA+120mA=998mA\). This was our inital conservative estimate for system current draw and if we had somehow miscalculated we could have lowered the LED brightness further. 
    </p>
  </div>

  <!-- Image and caption container -->
  <div style="flex: 0 0 300px; text-align: center;">
    <img src="assets/images/toggle.jpg" alt="THE toggle" style="max-width: 80%; height: auto; border: 1px solid #ccc; padding: 5px;">
    <p style="font-size: 12px; font-style: italic; margin-top: 5px;">Fig. IX: The nice E-Switch toggle to handle 1A</p>
  </div>
</div>

<div style="margin-left: 20px; text-align: left;">
  <p>

  </p>
</div>


<div style="display: flex; align-items: flex-start; margin-left: 20px; gap: 20px;">
  <!-- Image and caption container -->
  <div style="flex: 0 0 300px; text-align: center;">
    <img src="assets/images/battery.jpg" alt="Battery" style="max-width: 80%; height: auto; border: 1px solid #ccc; padding: 5px;">
    <p style="font-size: 12px; font-style: italic; margin-top: 5px;">Fig. X: The rechargeable LiPo pouch integrated into the 3D-printed housing</p>
  </div>

  <!-- Text container -->
  <div style="flex: 1;">
    <p>
      We also wanted the system to last at least 1 hour (a time chunk long enough for a reasonable workout). Filtering through battery options that had a small (wearable) form factor, were 3.7 volts, and close to 1Ah in capacity, we eventually landed on a 3.7V lithium-ion battery with 850mAh and dimensions of 43.0mm x 34.0mm x 6.2mm. We also found a Low-Dropout Linear Regulator (LDO) from TI that could step the 3.7V down to 3.3V to power everything on the board: the TLV1117LV33 (which can provide up to that peak 1A). It was surprisingly difficult to find a small and inexpensive on/off switch that could handle a full 1A. It seemed that slider switches are usually rated under 500mA, and most rockers were too big. Fortunately, we found a toggle switch (200MSP1T2B4M2QE by E-Switch) that has a satisfying click.
      <br><br>
      After about 10 days, the PCB arrived. There was one mistake involving the power switch, where the off pin was tied into the ground net, so the battery was shorted when turned off. Fortunately, we powered everything with a lab supply unit and corrected this issue by clipping the third pin of the switch. We also discovered the actual current draw of the system was much lower than expected at &lt;250mA. This was a great result for our battery life, which we eventually tested to exceed 3 hours for each sensor node. The battery is set into the bottom of the housing, a spliced connector goes into the board, and there is a slot where the charging cord can tuck into the bottom.
    </p>
  </div>
</div>



<div id="pcb-section" style="margin-left: 20px; text-align: left;">
  <h2 style="font-style: italic;">The PCB</h2>
  <p>
    The PCB (printed circuit board) was created in KiCAD, and the schematic is based on the development breadboard we built with through-hole parts. 
    We chose a 4-layer design so we had easy access to power and ground planes with vias. The board has a diameter of 60mm, although our edge cut 
    does have a 1mm margin, so we could potentially bring this design to 58mm. Through the entire PCB design process, we tried to keep things as 
    tight as possible to create sensor nodes that are actually wearable and do not encumber fitness movements while the system is in use. Initially, 
    we wanted the LED strips to encircle the "hockey puck" housing. There are two LED strips per node, each of length 70 mm, and with a diameter 
    of 60mm, that means we have a circumference of \( 2\pi \left(\frac{60mm}{2}\right)=188.49mm \). The BLE antenna has a no-go zone that blocks 
    the top flat portion of the board, leaving us only about 140mm remaining for both the 2.5mm AUX jacks and the LEDs. Later on, during the design 
    of the shirt, we realized we could make the LEDs removable from the housing and Velcro them to the shirt. This second setup would allow us to 
    shrink the board further. We also considered a double-sided board, flipping all the amps to the backside, but the assembly cost ended up 
    prohibitively high. The boards also include eleven probe locations we used to confirm proper analog performance of the board that could 
    presumably be sliced away to further shrink board area.
  </p>
</div>

<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 20px; text-align: center;">
  <div>
    <img src="assets/images/FlexGlO-F_Cu-cropped.svg" alt="Front" style="width: 100%; height: auto; border: 1px solid #ccc;">
  </div>
  <div>
    <img src="assets/images/FlexGlO-In1_Cu-cropped.svg" alt="In 1" style="width: 100%; height: auto; border: 1px solid #ccc;">
  </div>
  <div>
    <img src="assets/images/FlexGlO-B_Cu-cropped.svg" alt="Image 3" style="width: 100%; height: auto; border: 1px solid #ccc;">
  </div>
  <div>
    <img src="assets/images/FlexGlO-In2_Cu-cropped.svg" alt="In 2" style="width: 100%; height: auto; border: 1px solid #ccc;">
  </div>
</div>

<p style="text-align: center; font-size: 12px; font-style: italic; margin-top: 5px;">
  Fig. XI: [TOP LEFT CLOCKWISE] The four layers of the <span style="color:#39FF14;">FlexGl</span><span style="color:#FF073A;">O</span> PCB.
</p>

<div style="margin-left: 20px; text-align: left;">
  <p>
    All of the ICs on the board are installed with the default decoupling and stabilizing capacitors. To keep the design compact, all of the passive 
    components were selected to be in the 0402 package, with the exception of a few 1206 tantalum capacitors. We ordered the PCB to be partially 
    assembled from JLPCB. This meant altering some of the BOM (bill of materials) to include parts within JLPCB's basic library offering to keep 
    assembly and production costs low. Ordering partially assembled from JLPCB was a unique challenge because occasionally (for example, for the 
    AD623), a part would be significantly cheaper [we assume because JLPCB buys at volume and has a fraction available as surplus for hobbyists], 
    but we would have to pay a $3.00 "reel-swap" cost because it was on their "extended parts list." For the filters, often a slightly more common 
    resistor value might be on the basic list, and we ran simulations on resistor and capacitor alterations to assure the PCB kept to the performance 
    of the breadboarded design. As another benefit of partial assembly, the ESP32-S3 itself has an under-module ground spot that would have required a 
    hotplate setup to assemble ourselves, so we were fortunate to have JLPCB carry that part in stock. The power switch, electrode TRRS jacks, and the 
    TI filter amplifiers were not available on JLPCB, and we had to solder them ourselves. The only downside to the partial assembly was the gain 
    resistors. Recall from the analog section that selecting the correct gain was finicky on the breadboard, and removing and re-soldering a minuscule 
    0402 resistor on the edge of a board would have been a pain had we chosen poorly.
    <br><br>
    Routing was particularly difficult for the notch and bandpass filters, where there are numerous looping interconnects between the SOIC-8 pins of 
    the TI amplifiers. At the point of PCB design, we were still relatively unsure of the current requirements for our system, so we selected 0.75mm 
    traces for 3.7V off-battery, 0.5mm traces for the LED strip power and the ESP, and 0.25mm traces for the remaining nest. There are a few spidering 
    traces within the power and ground planes that are voltage references for the filter and the instrumentation amplifiers, respectively. There is a 
    circular cut-out in the lower right side of the board to route power cables and the LED wires through the housing.
  </p>
</div>

<div style="display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #ddd; padding-bottom: 20px; margin-bottom: 20px;">
  <div style="flex: 1; text-align: center; padding-right: 10px; border-right: 1px solid #ccc;">
    <img src="assets/images/fancy_top.png" alt="Rendered Top" style="max-width: 100%; height: auto;">
  </div>
  <div style="flex: 1; text-align: center; padding: 0 10px; border-right: 1px solid #ccc;">
    <img src="assets/images/PCB_design.png" alt="Raw Design" style="max-width: 100%; height: auto;">
  </div>
  <div style="flex: 1; text-align: center; padding-left: 10px;">
    <img src="assets/images/fancy_side.png" alt="Rendered Side" style="max-width: 100%; height: auto;">
  </div>
</div>

<p style="text-align: center; font-style: italic; font-size: 12px; margin-top: 10px;">
  Fig. XII: [Left] <span style="color: #39FF14;">FlexGl</span><span style="color: #FF073A;">O</span> PCB top-view 3D rendering. [Center] Busy KiCad PCB design overall view. [Right] <span style="color: #39FF14;">FlexGl</span><span style="color: #FF073A;">O</span> PCB side-view 3D rendering.
</p>

<div style="margin-left: 20px; text-align: left;">
  <p>
    After about ten days, we received our partially assembled PCB. There was only one mistake involving the power switch, which was discussed in the 
    Power section above. At first, we tried to surface-mount everything with a heat gun, but the plastic connectors proved to be particularly frail 
    up against the heat. The rest was done delicately with the iron. The TRRS jacks are very small and have only partial through-hole nubs for 
    mechanical support, so we had to re-solder those frequently over the course of debugging. The worst assembly issue involved the filter amps, 
    which were extremely sensitive to poor solder joints or even spare flux. We would assemble the whole system into its housing and find that the 
    slight torsion on the board had lifted the pins of the amp slightly, causing erratic behavior on the LEDs. We discovered this issue after 
    significant struggle when we accidentally pressed different corners of the quad-amps and found the system would miraculously work as intended. 
    <br><br>
    To program the board, we have three header pins to the left of the toggle switch. Despite the significant consternation online about the dangers of "bricking your ESP" by using the onboard USB Serial/JTAG Controller Console, we have flashed each node upwards of 100 times during debugging and never had any issues. We butchered a USB cable and simply connected D+, D-, and ground to the board, and it shows up like any typical USB device. At the breadboard stage, we were very careful to test all the bootstrap pin configurations to make sure this worked consistently. Using the onboard USB controller allowed us to exclude any additional serializer or USB-UART bridge chip in our space-constrained design.
  </p>
</div>

<div style="display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #ddd; padding-bottom: 20px; margin-bottom: 20px;">
  <div style="flex: 1; text-align: center; padding-right: 10px; border-right: 1px solid #ccc;">
    <img src="assets/images/rails.jpg" alt="Rails" style="max-width: 100%; height: auto;">
  </div>
  <div style="flex: 1; text-align: center; padding: 0 10px; border-right: 1px solid #ccc;">
    <img src="assets/images/assembled.jpg" alt="Completed" style="max-width: 100%; height: auto;">
  </div>
  <div style="flex: 1; text-align: center; padding-left: 10px;">
    <img src="assets/images/solder.jpg" alt="Soldered Jack" style="max-width: 100%; height: auto;">
  </div>
</div>

<p style="text-align: center; font-size: 12px; font-style: italic; margin-top: 10px;">
  Fig. XIII: [Left] PCB from JLPCB with rails. [Center] Fully assembled <span style="color: #39FF14;">FlexGl</span><span style="color: #FF073A;">O</span> PCB. [Right] Soldering the bottom TRRS jack for Node 0.
</p>

<div id="ble-section" style="display: block; padding-bottom: 20px;">
  <h2 style="margin-left: 20px; font-style: italic;">Connectivity with BLE</h2>
  <!-- Left side: First paragraph -->
  <p style="padding-left: 20px;">
    Initially we actually planned to use the ESP-NOW protocol and connect through a "central node" prior to linking with a mobile phone. Our group had limited experience with App development and it seemed easier to use an additional ESP32 as an information seive. But we realized that most phones could easiliy handle muple BLE connections easily. 
    <br><br>
    Library used for BLE. How the characteristics are setup. How data is passed. Ping-pong buffer mentioned
    <br><br>
    <b>More details coming!</b> Pictures of initial ESPC3 setup and test
    A screeenshot or gif of NRF app in action for debugging
  </p>
</div>

<div id="app-section" style="display: block; padding-bottom: 20px;">
  <h2 style="margin-left: 20px; font-style: italic;">Flexing a Fitness App</h2>
  <!-- Left side: First paragraph -->
  <p style="padding-left: 20px;">
    Why we landed on Flutter. The general architecture of it, challenges. What was that bug that we had to bypass etc
    <br><br>
    All of the in app screen shots. a gif of us changing colors
    <br><br>
    <b>More details coming!</b> Pictures of initial ESPC3 setup and test
  </p>
</div>

<div id="house-section" style="display: block; padding-bottom: 20px;">
  <h2 style="margin-left: 20px; font-style: italic;">The 3D Printed Shell</h2>
  <!-- Left side: First paragraph -->
  <p style="padding-left: 20px;">
    
    What software used Solidworks? Initial considerations about size from 64mm to 60mm. Discussion about LEDs inside versus outside. THe material selected. Where they were printed the approximate time to print them. Details about adding the charging port, the text and symbols. THe snap of the lid, mention the mounting screw
    <br><br>
    Nice highdef renderings of the hocley puck then pictures of the thing empty and a few close ups of the housing 
    <br><br>
    <b>More details coming!</b>
  </p>
</div>

<div id="textile-section" style="display: block; padding-bottom: 20px;">
  <h2 style="margin-left: 20px; font-style: italic;">High-Tech Tailor Fit</h2>
  <!-- Left side: First paragraph -->
  <p style="padding-left: 20px;">
    Why we chose the neoprene shirt. Different considerations four mounting the nodes. Talk about bad sizing for the shirt and the delays there. 
    <br><br>
    Gif of us showing the shirt stretches, close up of the stitching, some gif of the glue process. See the shirt Design document on Drive. Shirt with all wires out exposed. Picture of full ectrode on body 
    <br><br>
    <b>More details coming!</b>
  </p>
</div>

<div id="leftovers-section" style="text-align: left; margin-top: 40px; margin-bottom: 20px;">
  <h1>Contact and Lingering Queries</h1>
  <p>
    Thank you for your interest in <span style="color:#39FF14;">FlexGl</span><span style="color:#FF073A;">O</span>. If you notice anything wrong with our design or have any questions, feel free to reach out to     <a href="mailto:mbutton@umich.edu" style="color: blue; text-decoration: none;">mbutton@umich.edu</a>. We have listed a few prevailing issues we are aware of below:
    <ul>
      <li>
        <strong>Why do you not have ESD (electrostatic discharge) protection for any of your electrodes? Isn't it unsafe?</strong>
        <br>
        <em>The LiPo itself is only 3.7V and steps through an LDO to 3.3V, and its standard discharge is 0.2C (&asymp;172mA). Through repeated tests, the system maxes out at 250mA. Even for super wet, sweaty skin, any kind of reverse current would not push anything close to 250mA. The ground electrodes are also connected through 100k&Omega; resistor dividers. We realize that for this to be a medical-grade system, ESD protection would be required.</em>
      </li>
      <li>
        <strong>Why is there a ringing or oscillation in the filter amps around 165kHz?</strong>
        <br>
        <em>We have no idea. But it occurs in about half of the PCBs for the EMG circuits and causes fluctuations in the LED display as much as 3 lights high. If you are analog-inclined, we think it might have to do with the Notch filters and how we implemented them in single-supply mode.</em>
      </li>
      <li>
        <strong>Why don't you calibrate the ESP32's ADC to get more accurate voltage readouts?</strong>
        <br>
        <em>The voltage coming off the skin could change based on factors like body fat, sweat, or muscle volume. The LEDs have programmable gain so that the system will ignite for any user. In our use case, we were more concerned with proportionally displaying EMG voltages rather than measuring them with absolute accuracy.</em>
      </li>
      <li>
        <strong>The placement of the "bone ground" reference electrode is suspect.</strong>
        <br>
        <em>There is a single ground electrode shared by up to three circuits in our system. On the breadboard, we tried inserting the ground electrode at true ground and inside the divider circuit. We also initially tried using the bone reference solely for the instrumentation amp, but the voltage didn’t pass well into the filters. We decided to make the reference electrode true ground because it produced the cleanest results. Please correct us if the schematic is wrong.</em>
      </li>
      <li>
        <strong>Why did you consolidate the wait and LED tasks?</strong>
        <br>
        <em>Initially, we had two processes call <span style="font-family: Consolas, monospace;">FastLED.show()</span>, but there was always contention or some deadlock caused by a trapped mutex involving the RMT peripherals. Sometimes the system would run for an hour without freezing; other times, it would freeze after five minutes. Rather than delving into the library code, we consolidated the wait functionality and called <span style="font-family: Consolas, monospace;">FastLED.show()</span> only once.</em>
      </li>
    </ul>
  </p>
</div>


<div id="thankyou-section" style="text-align: left; margin-top: 40px; margin-bottom: 20px;">
 <h1>GlO-ing Gratitude</h1>
<p>
  We fully appreciate the facilities that the University of Michigan (Ann Arbor), provided to enable this project. This includes the EECS 473 Lab and the MESH (Michigan Embedded Systems Hub) Lab on North Campus, as well as the wide array of available equipment, ranging from oscilloscopes and wave generators to multimeters, soldering irons, and power supplies. We are also grateful for their extensive inventory of passive components, consumables (bare wire, flux, solder paste), and modules, which significantly eased the process of prototyping.
  <br><br>
  We were also well supported throughout the design process by Professor Mark Brehob and the EECS 473 lab staff, Matt Smith and James Carl. They provided invaluable counsel on significant design decisions and took the time to answer any questions, no matter how simple or redundant, on PCB design, assembly, software, and more. Their guidance was further complemented by the insights of the Fall '24 GSIs, who themselves had valuable experience from taking EECS 473 in prior semesters.
  <br><br>
  Finally, we extend our thanks to Optiver, who generously provided funding for this year’s projects, contributing $1,000.00 per group. We also appreciated their guest lecture on the engineering challenges they face as a market maker in the realm of low-latency trading.
</p>
</div>

<div style="display: flex; justify-content: center; align-items: center; gap: 256px; margin-top: 20px;">
  <img src="assets/images/stacked.svg" alt="Logo 1" style="width: 200px; height: auto;">
  <img src="assets/images/Optiver_Logo.svg" alt="Logo 2" style="width: 200px; height: auto;">
</div>
